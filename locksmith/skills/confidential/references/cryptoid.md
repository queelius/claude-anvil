# cryptoid Reference

## Overview

Client-side encrypted content for Hugo static sites. AES-256-GCM with PBKDF2-SHA256
key derivation. Per-user key wrapping so each user has independent credentials. Zero
server-side components — decryption happens in the browser via WebCrypto API.

## Configuration: `.cryptoid.yaml`

```yaml
users:
  alice: "strong-passphrase-for-alice"
  bob: "strong-passphrase-for-bob"

groups:
  admin: [alice]              # Special: universal access to ALL encrypted content
  team: [alice, bob]

salt: "a1b2c3d4e5f6a1b2..."  # 32 hex chars (16 bytes), generated by init
```

Add to `.gitignore`. Create interactively with `cryptoid init`.

## Front Matter Options

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `encrypted` | bool | `false` | Enable encryption for this page |
| `groups` | list | all users | Group names that get access |
| `password_hint` | string | `null` | Hint displayed on login form |
| `remember` | string | `"ask"` | Credential storage: `none`, `session`, `local`, `ask` |

## Cascade Resolution

Encryption propagates from `_index.md` to all content in that directory and subdirectories:

1. File's own front matter `encrypted` field takes priority
2. Walk up parent dirs checking each `_index.md`
3. Nearest `_index.md` with `encrypted` field wins
4. Nothing found = not encrypted

Rules:
- `_index.md` bodies are encrypted (front matter stays readable for cascade)
- `encrypted: false` overrides any inherited `true`
- A file's `groups` fully replaces inherited groups (no merging)
- For cascade inheritance, `_index.md` skips its own directory (no self-cascade)

## Build Workflow

```bash
cryptoid encrypt --content-dir content/    # Encrypt before Hugo build
hugo                                        # Build site normally
cryptoid decrypt --content-dir content/    # Restore plaintext for git
```

## CLI Commands

### Setup
```bash
cryptoid init [--config PATH] [--force]    # Interactive config creation
cryptoid hugo install                       # Install shortcode + JS into Hugo site
cryptoid hugo status                        # Check installation
cryptoid hugo uninstall                     # Remove cryptoid files
```

### Content Protection
```bash
cryptoid protect PATH --groups GROUP [--hint TEXT] [--remember MODE]
cryptoid protect -i [--config PATH]        # Interactive TUI mode
cryptoid unprotect PATH
```

### Crypto Operations
```bash
cryptoid encrypt --content-dir DIR [--config PATH] [--dry-run]
cryptoid decrypt --content-dir DIR [--config PATH]
cryptoid status --content-dir DIR [--config PATH] [--verbose]
cryptoid rewrap --content-dir DIR [--config PATH] [--rekey]
```

### User/Group Management
```bash
cryptoid config list-users [--config PATH]
cryptoid config add-user [USERNAME] [--group GROUP] [--config PATH]
cryptoid config remove-user USERNAME [--config PATH]
cryptoid config list-groups [--config PATH]
cryptoid config add-group NAME [--members USER1,USER2] [--config PATH]
cryptoid config remove-group NAME [--config PATH] [--force]
cryptoid config add-to-group GROUP USERNAME [--config PATH]
cryptoid config remove-from-group GROUP USERNAME [--config PATH]
cryptoid config generate-salt [--apply] [--config PATH]
cryptoid config show [--config PATH] [--show-passwords]
cryptoid config status
cryptoid config validate --content-dir DIR [--config PATH]
```

## Security Parameters

| Parameter | Value |
|-----------|-------|
| Cipher | AES-256-GCM |
| KDF | PBKDF2-SHA256 |
| Iterations | 310,000 |
| Salt | 16 bytes (shared, from config) |
| IV | 12 bytes (random per encryption) |
| Key wrapping | AES-256-GCM per user |
| Content hash | Truncated SHA-256 (128 bits) |

## Known Limitations

- External assets (images, PDFs) referenced in encrypted markdown are NOT encrypted
- Front matter (title, groups, etc.) stays in plaintext
- Hugo-generated metadata (RSS, sitemaps, search indexes) may leak titles
- Section list pages may reveal content structure

## Troubleshooting

**"Config file not found"**: Create with `cryptoid init` or specify path with `--config`.

**Already-encrypted files**: Running `encrypt` again is safe — already-encrypted files are skipped (idempotent).

**Decryption fails in browser**: Check password matches, verify JS is loaded (browser console), confirm shortcode HTML is intact.

**After adding/removing users**: Run `cryptoid rewrap` to update key blobs. Use `--rekey` after removing users for forward secrecy.
